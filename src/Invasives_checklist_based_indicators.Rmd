---
title: "Invasives_checklist_based_indicators"
author: "Sander Devisscher, Tim Adriaens"
date: "29 juli 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(trias)
library(rgbif)
library(tidyverse)
library(INBOtheme)
```

```{r Get Data}
#Script van Damiano zie issue #60 van trias-project/indicators (https://github.com/trias-project/indicators/issues/60)

#read taxon data
taxon <- read_csv(
  "https://raw.githubusercontent.com/trias-project/unified-checklist/include-distribution-regions/data/processed/taxon.csv",
  na = "")

#read distribution data
distribution <- read_csv(
  "https://raw.githubusercontent.com/trias-project/unified-checklist/include-distribution-regions/data/processed/distribution.csv",
  na = "")

#read description data
description <- read_csv(
  "https://raw.githubusercontent.com/trias-project/unified-checklist/include-distribution-regions/data/processed/description.csv",
  na = "")

#read species profile data
speciesProfile <- read_csv(
  "https://raw.githubusercontent.com/trias-project/unified-checklist/include-distribution-regions/data/processed/speciesprofile.csv",
  na = "")

# We *tidy* this data.frame, thus having different descriptors as different columns
description <- spread_with_multiple_values(data = description,
                                           key = type,
                                           value = description)
description %>% head(n = 10)

# Merge distribution, description and species profile information
merged_extensions <- 
  full_join(distribution %>% select(-c(source)),
            description %>% select(-c(source, language)),
            by = "taxonID") %>%
  full_join(speciesProfile,
            by = "taxonID")
merged_info <- left_join(taxon, merged_extensions,
                         by = "taxonID")
# remove "https://www.gbif.org/species/" from all taxonIDs
merged_info <-
  merged_info %>%
  mutate(key = sub(".*//www.gbif.org/species/", "", taxonID))

# Split column `eventDate`
merged_info <-
  merged_info %>% separate(col = eventDate,
                           sep = "/",
                           into = c("first_observed", "last_observed"),
                           convert = TRUE,
                           fill = "right",
                           remove = TRUE) %>%
  mutate(last_observed = ifelse(is.na(last_observed),
                                first_observed,
                                last_observed))

# Example
merged_info %>% 
  filter(locality == "Belgium") %>% 
  select(key, first_observed, last_observed) %>%
  distinct() %>%
  filter(!is.na(first_observed) & !is.na(last_observed)) %>%
  head()

# The column `pathway` contains a prefix, `cbd_2014_pathway:` and two different pathway levels divided by symbol `_`
merged_info %>% distinct(pathway) %>% filter(!is.na(pathway)) %>% head()

# Split `pathway` in `pathway_level1` and `pathway_level2`
merged_info <-
  merged_info %>% 
  rowwise() %>%
  mutate(pathway_level1 = 
           str_split_fixed(
             str_split(pathway,
                       pattern = "pathway:")[[1]][2],
             pattern = "_", n = 2)[[1]][1],
         pathway_level2 = 
           str_split_fixed(
             str_split(pathway,pattern = "pathway:")[[1]][2],
             pattern = "_", n = 2)[[2]][1]) %>%
  ungroup() %>%
  select(-pathway) 

```

```{r indicator_total_year}
table(distributions_unified$locality,useNA = "ifany")

checklist_flanders <- distributions_unified %>% 
  filter(locality == "Flemish Region")

checklist_flanders2 <- checklist_flanders %>% 
  mutate(taxonKeys = as.integer(taxonKeys)) 


%>% 
  left_join(taxa, by = c("taxonKeys" = "key")) %>% 
  filter(kingdom %in% c("Animalia", "Plantae"))

p <- indicator_total_year(checklist_flanders2, start_year_plot = 1940,
  x_major_scale_stepsize = 10, x_minor_scale_stepsize = 5,
  facet_column = "kingdom", first_observed = "startYear")

ggsave("data/processed/Invasives_cummulative_first_observed_kingdom.jpg", plot = p )
```
 
