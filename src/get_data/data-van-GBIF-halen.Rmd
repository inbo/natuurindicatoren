---
title: "Natuurindicatoren"
author: "Yasmine Verzelen"
date: "24 oktober 2017"
output: html_document
---

In dit script willen we de data van waarnemingen.be van GBIF halen, voor niet-inheemse planten en dieren.

Load packages
```{r}
library(rgbif)
library(curl)
library(ggplot2)
#library(INBOtheme)
```

Number of records in Waarnemingen.be datasets
```{r}
'Plants'
occ_count(datasetKey='7f5e4129-0717-428e-876a-464fbd5d9a47')
'Animals'
occ_count(datasetKey='9a0b66df-7535-4f28-9f4e-5bc11b8b096c')

```
Get the data from the datasets
```{r}
'Animals'
WnmBe_Animals <- occ_download_get(key = "0006839-171025204727650", overwrite = TRUE) %>% 
    occ_download_import(WnmBe_Animals_download, na.strings = c("", NA))
WnmBe_Animals$species <- as.character(WnmBe_Animals$species)

'Plants'
WnmBe_Plants <- occ_download_get(key = "0006843-171025204727650", overwrite = TRUE) %>% 
    occ_download_import(WnmBe_Plants_download, na.strings = c("", NA))

```

Merge the datasets
```{r}
WnmBe_All <- rbind(WnmBe_Animals, WnmBe_Plants)
```
Calculate the first occurence per species
```{r}
WnmBe_All <- subset(WnmBe_All, !is.na(species))
species <- unique(WnmBe_All$species)
species_list <- data.frame()
for(s in species){
  temp <- subset(WnmBe_All, species == s)
  temp2 <- data.frame(s)
  temp2$firstyear <- min(temp$year)
  temp2$kingdom <- unique(temp$kingdom)
  temp2$phylum <- unique(temp$phylum)
  temp2$class <- unique(temp$class)
  species_list <- rbind(species_list, temp2)
}

remove(temp)
remove(temp2)

```

Calculate the cumulative number of invasive species and display in a graph

```{r}

firstrecord <- min(species_list$firstyear)
newestrecord <- max(unique(WnmBe_All$year))
tijdspanne <- (newestrecord-firstrecord)+1

new_species <- data.frame()
temp2 <- data.frame(1)
t <- firstrecord

for(i in 1:tijdspanne){
  temp <- subset(species_list, firstyear == t)
  temp2$n <- nrow(temp)
  temp2$t <- t
  new_species <- rbind(new_species, temp2)
  t <- t + 1
}

new_species$X1 <- NULL
new_species$cumul <- cumsum(new_species$n)

plot <- ggplot(new_species, aes(x = t, y=cumul)) +
  geom_line(colour="red") +
  xlab("Year") + ylab("Number") + ggtitle("Cumulative number of invasive species") +
  scale_x_continuous(breaks = seq(1800, 2017, 10))+
  scale_y_continuous(breaks = seq(0,1900, 500))
  
print(plot)

```

Calculate the cumulative number of invasive species per kingdom and total and display in a graph
```{r}

firstrecord <- min(species_list$firstyear)
newestrecord <- max(unique(WnmBe_All$year))
tijdspanne <- (newestrecord-firstrecord)+1

new_species_k <- data.frame()
temp2 <- data.frame(1)
temp3 <- data.frame(1)
t <- firstrecord

kingdoms <- unique(species_list$kingdom)
for(k in kingdoms){
  temp <- subset(species_list, kingdom == k)
  for(i in 1:tijdspanne){
    temp2 <- subset(temp, firstyear == t)
    temp3$n <- nrow(temp2)
    temp3$t <- t
    temp3$kingdom <- k
    new_species_k <- rbind(new_species_k, temp3)
    t <- t + 1
  }
  t <- firstrecord
}

new_species_k$X1 <- NULL
new_species_k2 <-  transform(new_species_k,cumul = ave(n , kingdom, FUN = cumsum))

print(plot <- ggplot(new_species_k2, aes(x = t, y=cumul, colour = kingdom))+
  scale_x_continuous(breaks = seq(1800, 2017, 50))+
  scale_y_continuous(breaks = seq(0,1500, 500))+
  geom_line()+ 
  xlab("Year") + ylab("Number") + ggtitle("Cumulative number of invasive species per kingdom")+
  theme(panel.background = element_rect(fill = "aliceblue"))+
  theme(panel.grid.major = element_line(colour = "dark grey"))+
  theme(panel.grid.minor = element_line(colour = "light grey"))+
  theme(legend.title=element_blank())+
  theme(legend.background = element_rect(fill = "aliceblue")))

```


Make a graph of the different classes of invasive animals

```{r}

species_list_a <- subset(species_list, kingdom =="Animalia")

firstrecord <- min(species_list_a$firstyear)
newestrecord <- max(unique(WnmBe_All$year))
tijdspanne <- (newestrecord-firstrecord)+1

new_species_c <- data.frame()
temp2 <- data.frame(1)
temp3 <- data.frame(1)
t <- firstrecord

classes <- unique(species_list_a$class)
for(c in classes){
  temp <- subset(species_list_a, class == c)
  for(i in 1:tijdspanne){
    temp2 <- subset(temp, firstyear == t)
    temp3$n <- nrow(temp2)
    temp3$t <- t
    temp3$class <- c
    new_species_c <- rbind(new_species_c, temp3)
    t <- t + 1
  }
  t <- firstrecord
}

new_species_c$X1 <- NULL
new_species_c2 <-  transform(new_species_c,cumul = ave(n , class, FUN = cumsum))

print(plot <- ggplot(new_species_c2, aes(x=t, y=cumul))+
  geom_bar(position="dodge",stat="identity")+
  scale_x_continuous(breaks = seq(1800, 2017, 50))+
  scale_y_continuous(breaks = seq(0,1500, 500))+
  xlab("Year") + ylab("Number") + ggtitle("Cumulative number of invasive animal species per class")+
  theme(panel.background = element_rect(fill = "aliceblue"))+
  theme(panel.grid.major = element_line(colour = "dark grey"))+
  theme(panel.grid.minor = element_line(colour = "light grey"))+
  theme(legend.title=element_blank())+
  theme(legend.background = element_rect(fill = "aliceblue"))+
    
  facet_wrap(~class, nrow=6))
```



Make a graph of the different classes of invasive plants

```{r}
species_list_p <- subset(species_list, kingdom =="Plantae")

firstrecord <- min(species_list_p$firstyear)
newestrecord <- max(unique(WnmBe_All$year))
tijdspanne <- (newestrecord-firstrecord)+1

new_species_c <- data.frame()
temp2 <- data.frame(1)
temp3 <- data.frame(1)
t <- firstrecord

classes <- unique(species_list_p$class)
for(c in classes){
  temp <- subset(species_list_p, class == c)
  for(i in 1:tijdspanne){
    temp2 <- subset(temp, firstyear == t)
    temp3$n <- nrow(temp2)
    temp3$t <- t
    temp3$class <- c
    new_species_c <- rbind(new_species_c, temp3)
    t <- t + 1
  }
  t <- firstrecord
}

new_species_c$X1 <- NULL
new_species_c2 <-  transform(new_species_c,cumul = ave(n , class, FUN = cumsum))

print(plot <- ggplot(new_species_c2, aes(x=t, y=cumul))+
  geom_bar(position="dodge",stat="identity")+
  scale_x_continuous(breaks = seq(1800, 2017, 50))+
  scale_y_continuous(breaks = seq(0,1500, 500))+
  xlab("Year") + ylab("Number") + ggtitle("Cumulative number of invasive plant species per class")+
  theme(panel.background = element_rect(fill = "aliceblue"))+
  theme(panel.grid.major = element_line(colour = "dark grey"))+
  theme(panel.grid.minor = element_line(colour = "light grey"))+
  theme(legend.title=element_blank())+
  theme(legend.background = element_rect(fill = "aliceblue"))+
  facet_wrap(~class, nrow=6))

```


Gezien er hiervoor gewerkt werd met het eerste jaar van waarneming, maar er soms meerdere waarnemingen waren in dat eerste jaar, kunnen we door de procedure hierboven niet weten of de bijhorende geografische coördinaten wel kloppen. Vandaar eerst onderstaande analyse waardoor we die eerste datum wel weten.
```{r}
WnmBe_first <- WnmBe_All[WnmBe_All$eventdate == ave(WnmBe_All$eventdate, WnmBe_All$species, FUN=min), ]

```

```{r}
library(plyr)
WnmBe_first <- rename(WnmBe_first, c("species"="s"))
temp4 <- merge(species_list, WnmBe_first, all.y=FALSE)
WnmBe_Points <- temp4[temp4$gbifid == ave(temp4$gbifid, temp4$s, FUN=min), ]
```

Kaart maken van de eerste occurences van alle soorten in Vlaanderen.
Hier zijn er wat problemen, oa. met de versie van R waardoor het package niet werkt... Ik zoek naar een betere package met map van Vlaanderen.
```{r}
install.packages("BelgiumMaps.OpenStreetMap", repos = "http://www.datatailor.be/rcube", type = "source")
```

In plaats van fancy te starten met mooie kaartjes, beginnen we op een eenvoudige manier. 
```{r}
library(rworldmap)

map <- getMap(resolution = "low")
plot(map, xlim = c(2.54, 6), ylim = c(50.70, 51.51), asp = 1)

points(WnmBe_Points$decimallongitude, WnmBe_Points$decimallatitude, col = "red", cex = .6)



```




